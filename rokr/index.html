<!DOCTYPE html>
<html>
    <head>
        <title>ROKR - RAiD OKR Management Platform</title>

        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="../css/dataTables.bootstrap4.min.css">
        <link rel="stylesheet" type="text/css" href="styles.css">

        <!-- Configs -->
        <script type="text/javascript">
            // Configs
            const teams = [
                {teamName: 'HQ RAiD', slug: 'hq-raid'},
                {teamName: 'PAB', slug: 'pab'},
                {teamName: 'SWiFT', slug: 'swift'},
                {teamName: 'RDO', slug: 'rdo'},
                {teamName: 'CyDef', slug: 'cydef'},
                {teamName: 'SES', slug: 'ses'}
            ];

            // URLs
            const txtUrl = 'https://raw.githubusercontent.com/chrischow/project-ace/main/txt/';
            const appUrl = 'https://raw.githubusercontent.com/chrischow/project-ace/main/rokr/components/';

            // List IDs
            const objListId = 'cca0eabc-f2bd-4866-ba60-a3009004066d';
            const  krListId = '08572e86-a0aa-4173-ba18-79bab1ee3890';

            // List item entity types - use the getListItemEntityType utility;
            const objListItemEntityTypeFullName = 'SP.Data.ROKR_x0020_ObjectivesListItem';
            const krListItemEntityTypeFullName = 'SP.Data.RokrKeyResultsListItem';
        </script>

        <!-- Load utils -->
        <script type="text/javascript">
            function loadWords(filename, asynch) {
                // Retrieve text
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var sTag = document.createElement('script');
                        sTag.type = 'text/javascript';
                        sTag.innerHTML = this.responseText;
                        var head = document.getElementsByTagName('head')[0];
                        head.appendChild(sTag);
                    }
                };
                var url = txtUrl + filename + '.txt';
                xhr.open('GET', url, asynch);
                xhr.send();
            };

            function loadComponent(component) {
                // Retrieve text
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var sTag = document.createElement('script');
                        sTag.type = 'text/babel';
                        sTag.innerHTML = this.responseText;
                        var head = document.getElementsByTagName('head')[0];
                        head.appendChild(sTag);
                    }
                };
                var url = appUrl + component + '.txt';
                
                xhr.open('GET', url, false);
                xhr.send();
            };

            // Load utils
            loadWords('jquery-3.2.1.min', false);
            loadWords('bootstrap-4.6.0.min', true);
            loadWords('jquery.dataTables-1.10.20.min', false);
            loadWords('dataTables.bootstrap4-1.10.20.min', true);
            loadWords('react.production.min', false);
            loadWords('react-dom.production.min', false);
            loadWords('react-router-dom.min', false);
            loadWords('babel-6.26.0.min', false);
            loadWords('circle-progress.min', false);
            loadWords('update-circle-progress', false);
            
            // Routing
            const HashRouter = ReactRouterDOM.HashRouter;
            const Route = ReactRouterDOM.Route;
            const Switch = ReactRouterDOM.Switch;
            const Link = ReactRouterDOM.Link;
            const NavLink = ReactRouterDOM.NavLink;

            // Load components
            loadComponent('fake-data');
            loadComponent('Brand');
            loadComponent('Navbar');
            loadComponent('ProgressCard');
            loadComponent('HomeCards');
            loadComponent('ProgressBar');
            loadComponent('Home');
            loadComponent('CaretIcon');
            loadComponent('EditIcon');
            loadComponent('OKRCollapse');
            loadComponent('Forms');
            loadComponent('Team');
        </script>
    </head>
    <body>
        <div id="root"></div>
        <script type="text/babel">
            function computeKrCompletion(data) {
    
                var krCompleted = data.map(function(entry) {
                    var pct = entry.currentValue / entry.maxValue;
                    return pct === 1.0 ? 1 : 0;
                }).reduce((prev, next) => prev + next, 0);
                
                return {
                    completed: krCompleted,
                    total: data.length
                };
            }
            
            function computeObjCompletion(objectives, keyResults) {
                
                var total = objectives.length;
                var completed = 0;
                var filteredKRs;
                var completedKRs;
                var numKRs;
                var pctCompletion;
                var avgCompletion = 0;
                for (var i=0; i<objectives.length; i++) {
                    
                    // Filter KRs for each objective
                    filteredKRs = keyResults.filter(function(kr) {
                        return kr.parentObjectiveId === objectives[i].objectiveId;
                    });
                    numKRs = filteredKRs.length;
            
                    // Compute average completion
                    pctCompletion = filteredKRs.map(function(kr) {
                        return kr.currentValue / kr.maxValue;
                    })
                    avgCompletion += pctCompletion.reduce(function(a, b) { return a + b }, 0) / numKRs;
                    completedKRs = filteredKRs.filter(function(kr) {
                        return kr.currentValue === kr.maxValue;
                    });
            
                    if (numKRs === completedKRs.length) {
                        completed ++;
                    }
                }
            
                avgCompletion /= total;
            
                return { completed, total, avgCompletion };
            }
            
            var annualObjectives = allData.objectives.filter(function(obj) {
                return obj.frequency === 'annual';
            });
            
            var annualKRs = allData.keyResults.filter(function(kr) {
                var objs = annualObjectives.filter(function(obj) {
                    return obj.objectiveId === kr.parentObjectiveId;
                });
                return objs.length > 0;
            })
            
            var tempObjCompletion = computeObjCompletion(annualObjectives, annualKRs);
            
            var overallProgressData = {
                avgCompletion: tempObjCompletion.avgCompletion,
                keyResultCompletion: computeKrCompletion(annualKRs),
                objectiveCompletion: {
                    completed: tempObjCompletion.completed,
                    total: tempObjCompletion.total,
                }
            };
            
            // Split data
            function prepareTeamData() {
                var output = {};
                var freqs = ['annual', 'quarterly', 'monthly'];
                var tempObj;
                var parentObj;
                var tempKR;
                var tempObjCompletion;
                for (var t=0; t < teams.length; t++) {
                    output[teams[t].teamName] = {};
                    for (var f=0; f < freqs.length; f++) {
                        tempObj = allData.objectives.filter(function(entry) {
                            return (entry.team === teams[t].teamName) && (entry.frequency === freqs[f]);
                        })
                        tempKR = allData.keyResults.filter(function(entry) {
                            parentObj = allData.objectives.filter(obj => obj.objectiveId === entry.parentObjectiveId)[0];
                            return (entry.parentObjectiveTeam === teams[t].teamName) && (
                                parentObj.frequency === freqs[f]
                            );
                        })
                        tempObjCompletion = computeObjCompletion(tempObj, tempKR);
                        output[teams[t].teamName][freqs[f]] = {
                            avgCompletion: tempObjCompletion.avgCompletion,
                            keyResultCompletion: computeKrCompletion(tempKR),
                            objectiveCompletion: {
                                completed: tempObjCompletion.completed,
                                total: tempObjCompletion.total,
                            },
                            objectives: tempObj,
                            keyResults: tempKR
                        };
                    }
                }
                return output;
            }
            
            var teamProgressData = prepareTeamData();
            
            // Routes
            const TeamRoutes = (props) => {
                var teams = props.teams;
                const routes = props.teams.map(function(team) {
                  
                return (
                    <Route 
                        key={team.slug}
                        path={'/' + team.slug}
                        render={(props) => <TeamPage
                            team={team}
                            teams={teams}
                            progressData={teamProgressData[team.teamName]}
                        />}
                    />
                  );
              });
            
              return (
                  <div>
                  {routes}
                  </div>
              );
            }
            
            // Home page
            function renderHome(props) {
                    
                return (
                    <Home
                        teams={teams}
                        overallProgressData={overallProgressData}
                        teamProgressData={teamProgressData}
                    />
                );
            }
            
            // App
            function App() {
              return (
                  <HashRouter>
                      <Navbar teams={teams} />
                      <div className="container mt-5">
                          <Switch>
                              <Route 
                                  path='/'
                                  render={renderHome}
                                  exact
                              />
                              <TeamRoutes teams={teams} />
                          </Switch>
                      </div>
                  </HashRouter>
              )
            }

            // Render
            ReactDOM.render(
                <App />,
                document.getElementById('root')
            );
        </script>
    </body>
</html>